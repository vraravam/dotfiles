compdef push_all_repos
#!/usr/bin/env zsh

# vim:filetype=zsh syntax=zsh tabstop=2 shiftwidth=2 softtabstop=2 expandtab autoindent fileencoding=utf-8

# Source shell helpers if they aren't already loaded
type is_shellrc_sourced 2>&1 &> /dev/null || source "${HOME}/.shellrc"

# Pushes the specified repo
# internal function: not to be called separately
_push_repo() {
  if ! is_git_repo "${1}"; then
    warn "skipping pushing the repo since '$(yellow "${1}")' doesn't exist or is not a git repo"
    return 0 # Success, nothing to do
  fi

  section_header "$(yellow 'Pushing') $(purple "${1}")"
  git -C "${1}" push --progress --force-with-lease
  if [ $? -eq 0 ]; then
    success "Successfully pushed '$(yellow "${1}")'"
  else
    warn "Couldn't push '$(yellow "${1}")'"
  fi
}

# Pushes the home and profiles repos to their respective remotes (disables and re-enables cron while doing this operation)
push_all_repos() {
  crontab -r 2>&1 &> /dev/null

  _push_repo "${HOME}"
  _push_repo "${PERSONAL_PROFILES_DIR}"

  recron
}

push_all_repos "$@"
