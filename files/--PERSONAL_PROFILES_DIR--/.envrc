#!/usr/bin/env bash

# vim:filetype=bash syntax=bash tabstop=2 shiftwidth=2 softtabstop=2 expandtab autoindent fileencoding=utf-8

# This script is invoked by `direnv` each time you cd into this folder (and assuming that you have run `direnv allow` for this version of this script).
# The main reason to move these steps outside of the `fresh-install-of-osx.sh` script is that these steps are required each time the user installs and starts a new browser (which is included in the logic below).

type is_shellrc_sourced 2>&1 &> /dev/null || source "${HOME}/.shellrc"

if is_zero_string "${PERSONAL_PROFILES_DIR}"; then
  warn "'$(yellow 'PERSONAL_PROFILES_DIR')' env var is not set. Aborting!!!"
  return 0 # Success, nothing to do
fi

replace_dir_if_exists_and_is_not_symlinked() {
  if [[ $# -ne 2 ]]; then
    warn "Usage: ${0} <source-dir> <target-dir>"
    return 1 # Failure, invalid arguments
  fi

  # Note: This assumes that the empty directory has been created prior to calling this function
  local target="${PERSONAL_PROFILES_DIR}/${2}"
  if ! is_directory "${1}" && ! is_directory "${target}"; then
    warn "skipping symlinking '$(yellow "${2}")' since either source or target don't exist!!!"
    return 0 # Success, nothing to do
  fi

  ensure_dir_exists "$(dirname "${1}")"
  ensure_dir_exists "${target}"

  # If the folder exists but is not a symlink, move it into the source location
  is_directory "${1}" && ! test -L "${1}" && rm -rf "${target}" && mv -fv "${1}" "${target}"

  # if the folder doesn't exist, create the symlink
  ! is_directory "${1}" && ln -sf "${target}" "${1}" && success "Successfully symlinked '$(yellow "${1}")' --> '$(yellow "${target}")'!!!"

  rm -rfv "${2}/${2}" # if this is eval'ed by multiple processes in parallel, then we end up with nested folders!

  unset target
}

# Capture Arc profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/Arc" "ArcProfile"

# Capture Brave profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/BraveSoftware/Brave-Browser" "BraveProfile"

# Capture Brave profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/TorBrowser-Data" "TorProfile"

# Capture Chrome profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/Google/Chrome" "ChromeProfile"

# Capture Chrome Beta profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/Google/Chrome Beta" "ChromeBetaProfile"

# Capture Ferdium profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/Ferdium" "FerdiumProfile"

# Capture Syncthing profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/Syncthing" "SyncthingProfile"

# Capture Firefox profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/Firefox" "FirefoxProfile"

# Capture Floorp profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/Floorp" "FloorpProfile"

# Capture Zen profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/Zen" "ZenProfile"

# Capture Thunderbird profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Thunderbird" "ThunderbirdProfile"

# Capture KeePassXC profile folder into git-tracked location
replace_dir_if_exists_and_is_not_symlinked "${HOME}/Library/Application Support/KeePassXC" "KeePassXCProfile"

# Clone the natsumi-browser repo into specified browser profile chrome folders and switch to the 'dev' branch
local -a browsers=(FirefoxProfile)
for browser in "${browsers}"; do
  local folder="${PERSONAL_PROFILES_DIR}/${browser}"
  if is_directory "${folder}"; then
    clone_repo_into "git@github.com:${UPSTREAM_GH_USERNAME}/natsumi-browser" "${folder}/Profiles/DefaultProfile/chrome" dev || warn "Failed to clone natsumi-browser for '$(yellow "${browser}")'"
  else
    warn "skipping cloning of natsumi repo for '$(yellow "${browser}")' as its profile directory structure is not present."
  fi
  unset folder
done
unset browsers

# For each of the browsers, if their 'chrome' folder is a git repo, add the upstream remote to use my fork (so that updates are just a matter of doing `git pull`)
local chrome_folders=("${PERSONAL_PROFILES_DIR}"/*Profile/Profiles/DefaultProfile/chrome)
if [[ ${#chrome_folders[@]} -gt 0 ]]; then
  for folder in "${chrome_folders[@]}"; do
    # Setup the chrome repo's upstream if it doesn't already point to UPSTREAM_GH_USERNAME's repo
    add-upstream-git-config.sh -d "${folder}" -u "${UPSTREAM_GH_USERNAME}" || warn "Failed to add upstream git config for '$(yellow "${folder}")'"
  done
  unset folder
else
  warn "No '*Profile/Profiles/DefaultProfile/chrome' directories found to set upstream for."
fi
unset chrome_folders
